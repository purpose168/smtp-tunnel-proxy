#!/usr/bin/env python3
"""
SMTP 隧道 - 列出用户脚本

显示所有已配置的用户。

版本: 1.3.0
"""

import argparse
import os
import sys

# 将当前目录添加到路径以便导入
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from common import load_users


def main():
    """主函数"""
    parser = argparse.ArgumentParser(
        description='列出所有 SMTP 隧道用户',
        formatter_class=argparse.RawDescriptionHelpFormatter
    )
    parser.add_argument('--users-file', '-u', default='/etc/smtp-tunnel/users.yaml', help='用户文件（默认：/etc/smtp-tunnel/users.yaml）')
    parser.add_argument('--verbose', '-v', action='store_true', help='显示详细信息')

    args = parser.parse_args()

    # 获取基础目录
    base_dir = os.path.dirname(os.path.abspath(__file__))

    # 加载用户
    users_file = args.users_file
    if not os.path.isabs(users_file):
        users_file = os.path.join(base_dir, users_file)

    users = load_users(users_file)

    # 检查是否有用户
    if not users:
        print("未配置用户")
        print(f"使用 smtp-tunnel-adduser 添加用户")
        return 0

    # 显示用户列表
    print(f"用户 ({len(users)}):")
    print("-" * 60)

    for username, user in sorted(users.items()):
        if args.verbose:
            # 详细模式
            print(f"\n  {username}:")
            print(f"    密钥: {user.secret[:8]}...{user.secret[-4:]}")
            if user.whitelist:
                print(f"    白名单: {', '.join(user.whitelist)}")
            else:
                print(f"    白名单: (任意 IP)")
            print(f"    日志: {'启用' if user.logging else '禁用'}")
        else:
            # 简洁模式
            whitelist_info = f" [{len(user.whitelist)} 个IP]" if user.whitelist else ""
            logging_info = " [无日志]" if not user.logging else ""
            print(f"  {username}{whitelist_info}{logging_info}")

    # 如果不是详细模式，提示使用 -v
    if not args.verbose:
        print()
        print("使用 -v 查看详细信息")

    return 0


if __name__ == '__main__':
    sys.exit(main())
