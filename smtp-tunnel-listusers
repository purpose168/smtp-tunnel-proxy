#!/usr/bin/env python3
"""
SMTP 隧道 - 列出用户脚本

显示所有已配置的用户。

版本: 1.3.0
"""

import argparse  # 命令行参数解析库
import os        # 操作系统接口库
import sys       # 系统相关功能库

# 将当前目录添加到导入路径，以便导入本地模块
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from common import load_users  # 导入用户加载函数


def main():
    parser = argparse.ArgumentParser(
        description='列出所有 SMTP 隧道用户',
        formatter_class=argparse.RawDescriptionHelpFormatter
    )
    parser.add_argument('--users-file', '-u', default='/opt/smtp-tunnel/config/users.yaml', help='用户文件（默认: /opt/smtp-tunnel/config/users.yaml）')
    parser.add_argument('--verbose', '-v', action='store_true', help='显示详细信息')

    args = parser.parse_args()

    # 获取基础目录
    base_dir = os.path.dirname(os.path.abspath(__file__))

    # 加载用户
    users_file = args.users_file
    if not os.path.isabs(users_file):
        users_file = os.path.join(base_dir, users_file)  # 转换为绝对路径

    users = load_users(users_file)  # 加载用户数据

    if not users:
        print("未配置用户")
        print(f"使用 smtp-tunnel-adduser 添加用户")
        return 0

    print(f"用户 ({len(users)}):")
    print("-" * 60)

    for username, user in sorted(users.items()):
        if args.verbose:
            print(f"\n  {username}:")
            print(f"    密钥: {user.secret[:8]}...{user.secret[-4:]}")  # 显示密钥的前8位和后4位
            if user.whitelist:
                print(f"    白名单: {', '.join(user.whitelist)}")
            else:
                print(f"    白名单: (任意 IP)")
            print(f"    日志记录: {'已启用' if user.logging else '已禁用'}")
        else:
            whitelist_info = f" [{len(user.whitelist)} 个 IP]" if user.whitelist else ""
            logging_info = " [无日志]" if not user.logging else ""
            print(f"  {username}{whitelist_info}{logging_info}")

    if not args.verbose:
        print()
        print("使用 -v 查看详细信息")

    return 0


if __name__ == '__main__':
    sys.exit(main())
