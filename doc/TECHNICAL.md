# 📧 SMTP 隧道 - 技术文档

本文档提供了 SMTP 隧道代理的深入技术细节，包括协议设计、DPI 规避技术、安全分析和实现细节。

> 📖 基本设置和使用说明，请参阅 [README.md](README.md)。

---

## 📑 目录

- [📨 为什么选择 SMTP？](#-为什么选择-smtp)
- [🎭 如何绕过 DPI](#-如何绕过-dpi)
- [⚡ 为什么速度快](#-为什么速度快)
- [🏗️ 架构](#️-架构)
- [📐 协议设计](#-协议设计)
- [🔧 组件详情](#-组件详情)
- [🔐 安全分析](#-安全分析)
- [🌐 域名 vs IP 地址](#-域名-vs-ip-地址安全影响)
- [⚙️ 高级配置](#️-高级配置)

---

## 📨 为什么选择 SMTP？

SMTP（简单邮件传输协议）是用于发送电子邮件的协议。它是隧道传输的绝佳选择，原因如下：

### 1️⃣ 普遍存在的流量
- 电子邮件是基础设施 - 阻止它会破坏合法服务
- 端口 587（提交端口）上的 SMTP 流量是预期且正常的
- 每秒有数百万封电子邮件在网络中传输

### 2️⃣ 预期会被加密
- STARTTLS 是 SMTP 的标准 - 加密邮件是正常的
- DPI 系统预期会看到 TLS 加密的 SMTP 流量
- 加密内容不会引起警觉

### 3️⃣ 灵活的协议
- SMTP 允许大数据传输（附件）
- 二进制数据是正常的（MIME 编码的附件）
- 长连接是可接受的

### 4️⃣ 难以阻止
- 阻止端口 587 会破坏所有人的电子邮件
- 在 TLS 后难以区分隧道和真实邮件
- 需要阻止所有加密邮件

---

## 🎭 如何绕过 DPI

深度包检测（DPI）系统分析网络流量以识别和阻止某些协议或内容。以下是 SMTP 隧道如何规避检测：

### 🔍 阶段 1：欺骗（明文）

```
┌──────────────────────────────────────────────────────────────┐
│                    DPI 可以看到此内容                          │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  Server: 220 mail.example.com ESMTP Postfix (Ubuntu)         │
│  Client: EHLO client.local                                   │
│  Server: 250-mail.example.com                                │
│          250-STARTTLS                                        │
│          250-AUTH PLAIN LOGIN                                │
│          250 8BITMIME                                        │
│  Client: STARTTLS                                            │
│  Server: 220 2.0.0 Ready to start TLS                        │
│                                                              │
│  DPI 分析: "这是一个正常的邮件服务器连接"                      │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**DPI 看到的内容：**
- 来自 "Postfix" 邮件服务器的标准 SMTP 问候
- 正常的能力协商
- STARTTLS 升级（安全邮件所预期）

**使其具有说服力的原因：**
- 问候语匹配真实的 Postfix 服务器
- 能力列表是现实的
- 符合 RFC 5321 规范
- 端口 587 是标准的 SMTP 提交端口

### 🔒 阶段 2：TLS 握手

```
┌──────────────────────────────────────────────────────────────┐
│                    DPI 可以看到此内容                          │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  [TLS 1.2/1.3 握手]                                         │
│  - Client Hello                                              │
│  - Server Hello                                              │
│  - 证书交换                                                   │
│  - 密钥交换                                                   │
│  - 完成                                                       │
│                                                              │
│  DPI 分析: "邮件加密的正常 TLS"                               │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**DPI 看到的内容：**
- 标准 TLS 握手
- 邮件域的服务器证书
- 正常的密码协商

### 🚀 阶段 3：加密隧道（不可见）

```
┌──────────────────────────────────────────────────────────────┐
│                   DPI 无法看到此内容                          │
│                   (使用 TLS 加密)                            │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  Client: EHLO client.local                                   │
│  Server: 250-mail.example.com                                │
│          250-AUTH PLAIN LOGIN                                │
│          250 8BITMIME                                        │
│  Client: AUTH PLAIN <token>                                  │
│  Server: 235 2.7.0 Authentication successful                 │
│  Client: BINARY                                              │
│  Server: 299 Binary mode activated                           │
│                                                              │
│  [二进制流开始 - 原始 TCP 隧道]                               │
│                                                              │
│  DPI 分析: "加密的邮件会话，无法检查"                          │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

**DPI 看到的内容：**
- 加密的 TLS 流量
- 数据包大小和时间与邮件一致
- 无法检查内容

**实际发生的情况：**
- 使用预共享密钥进行身份验证
- 切换到二进制流模式
- 全速 TCP 隧道传输

### ❌ 为什么 DPI 无法检测它

| DPI 技术 | 为什么失败 |
|---------------|--------------|
| **端口分析** | 使用标准 SMTP 端口 587 |
| **协议检测** | 初始握手是有效的 SMTP |
| **TLS 指纹识别** | 标准 Python SSL 库 |
| **数据包大小分析** | 可变大小，类似于邮件 |
| **时序分析** | 没有明显的模式 |
| **深度检查** | 内容使用 TLS 加密 |

---

## ⚡ 为什么速度快

以前的版本对每个数据包都使用 SMTP 命令，需要：
- 每个数据块 4 次往返（MAIL FROM → RCPT TO → DATA → 响应）
- Base64 编码（33% 开销）
- MIME 包装（更多开销）

### 🚀 新方法：协议升级

```
┌─────────────────────────────────────────────────────────────┐
│                    握手阶段                                  │
│                    (仅一次)                                  │
├─────────────────────────────────────────────────────────────┤
│  EHLO → STARTTLS → TLS → EHLO → AUTH → BINARY               │
│                                                             │
│  时间: ~200-500ms（取决于网络延迟）                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    流阶段                                    │
│                    (会话的其余部分)                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────┬────────────┬────────────┬─────────────┐        │
│  │  类型   │  通道 ID   │   长度     │   负载      │        │
│  │ 1 字节  │  2 字节    │  2 字节    │  N 字节     │        │
│  └─────────┴────────────┴────────────┴─────────────┘        │
│                                                             │
│  - 全双工 - 同时发送和接收                                   │
│  - 无需等待响应                                              │
│  - 每帧 5 字节开销（vs SMTP 数百字节）                        │
│  - 原始二进制 - 无 base64 编码                               │
│  - 速度仅受网络带宽限制                                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 📊 性能比较

| 指标 | 旧 SMTP 方法 | 新二进制方法 |
|--------|-----------------|-------------------|
| **每个数据包的开销** | ~500+ 字节 | 5 字节 |
| **每次发送的往返次数** | 4 | 0（流式传输） |
| **编码开销** | 33%（base64） | 0% |
| **双工模式** | 半双工 | 全双工 |
| **有效速度** | ~10-50 KB/s | 受带宽限制 |

---

## 🏗️ 架构

### 🖥️ 系统组件

```
您的计算机                           您的 VPS                        互联网
┌────────────────────┐                  ┌────────────────────┐          ┌─────────┐
│                    │                  │                    │          │         │
│  ┌──────────────┐  │                  │  ┌──────────────┐  │          │ 网站    │
│  │   浏览器      │  │                  │  │    服务器    │  │          │   API   │
│  │   或应用     │  │                  │  │   server.py  │  │          │ 服务    │
│  └──────┬───────┘  │                  │  └──────┬───────┘  │          │         │
│         │          │                  │         │          │          └────┬────┘
│         │ SOCKS5   │                  │         │ TCP      │               │
│         ▼          │                  │         ▼          │               │
│  ┌──────────────┐  │   TLS 隧道      │  ┌──────────────┐  │               │
│  │    客户端    │◀─┼──────────────────┼─▶│   出站连接   │◀─┼───────────────┘
│  │   client.py  │  │   端口 587       │  │  Connector   │  │
│  └──────────────┘  │                  │  └──────────────┘  │
│                    │                  │                    │
└────────────────────┘                  └────────────────────┘
     受审查的网络                          自由互联网
```

### 📡 数据流

```
1. 浏览器想要访问 https://example.com

2. 浏览器 → SOCKS5 (client.py:1080)
   "CONNECT example.com:443"

3. 客户端 → 服务器 (端口 587，看起来像 SMTP)
   [帧: CONNECT, channel=1, "example.com:443"]

4. 服务器 → example.com:443
   [打开真实的 TCP 连接]

5. 服务器 → 客户端
   [帧: CONNECT_OK, channel=1]

6. 浏览器 ↔ 客户端 ↔ 服务器 ↔ example.com
   [双向数据流]
```

---

## 📐 协议设计

### 📦 帧格式（二进制模式）

握手后的所有通信都使用这种简单的二进制帧格式：

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
├─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┼─┤
│     类型      │          通道 ID           │    长度       │
├───────────────┼───────────────────────────────┼───────────────┤
│    长度       │            负载...                          │
├───────────────┼───────────────────────────────────────────────┤
│                        负载（继续）                          │
└───────────────────────────────────────────────────────────────┘

类型 (1 字节):
  0x01 = DATA         - 隧道数据
  0x02 = CONNECT      - 打开新通道
  0x03 = CONNECT_OK   - 连接成功
  0x04 = CONNECT_FAIL - 连接失败
  0x05 = CLOSE        - 关闭通道

通道 ID (2 字节): 标识连接（支持 65535 个同时连接）
长度 (2 字节): 负载大小（最大 65535 字节）
负载 (可变): 实际数据
```

### 🔗 CONNECT 负载格式

```
┌───────────────┬─────────────────────────┬───────────────┐
│  主机长度     │         主机             │     端口      │
│   (1 字节)    │    (可变, UTF-8)         │   (2 字节)    │
└───────────────┴─────────────────────────┴───────────────┘
```

### 🔄 会话状态机

```
                    ┌─────────┐
                    │  开始   │
                    └────┬────┘
                         │
                         ▼
              ┌─────────────────────┐
              │   TCP 已连接        │
              └──────────┬──────────┘
                         │ 220 问候
                         ▼
              ┌─────────────────────┐
              │   EHLO 交换         │
              └──────────┬──────────┘
                         │ 250 OK
                         ▼
              ┌─────────────────────┐
              │     STARTTLS       │
              └──────────┬──────────┘
                         │ 220 就绪
                         ▼
              ┌─────────────────────┐
              │   TLS 握手          │
              └──────────┬──────────┘
                         │ 成功
                         ▼
              ┌─────────────────────┐
              │   EHLO (TLS 后)     │
              └──────────┬──────────┘
                         │ 250 OK
                         ▼
              ┌─────────────────────┐
              │   AUTH PLAIN        │
              └──────────┬──────────┘
                         │ 235 成功
                         ▼
              ┌─────────────────────┐
              │   BINARY 命令       │
              └──────────┬──────────┘
                         │ 299 OK
                         ▼
              ┌─────────────────────┐
              │   二进制流传输      │◀──────┐
              │   (全双工)           │───────┘
              └─────────────────────┘
```

---

## 🔧 组件详情

### 🖥️ server.py - 服务器组件

**用途：** 在不受审查的网络中的 VPS 上运行。接受隧道连接并将流量转发到真实的互联网。

**功能：**
- 监听端口 587（SMTP 提交端口）
- 表现为 Postfix 邮件服务器
- 处理 SMTP 握手（EHLO、STARTTLS、AUTH）
- 身份验证后切换到二进制流模式
- 管理多个隧道通道
- 将数据转发到目标服务器
- 通过隧道发回响应

**关键类：**
| 类 | 描述 |
|-------|-------------|
| `TunnelServer` | 主服务器，接受连接 |
| `TunnelSession` | 处理一个客户端连接 |
| `Channel` | 表示一个隧道 TCP 连接 |

### 💻 client.py - 客户端组件

**用途：** 在本地计算机上运行。提供 SOCKS5 代理接口并通过服务器隧道传输流量。

**功能：**
- 在 localhost:1080 上运行 SOCKS5 代理服务器
- 连接到端口 587 上的隧道服务器
- 执行 SMTP 握手以看起来合法
- 切换到二进制流模式
- 在单个隧道上多路复用多个连接
- 处理来自应用程序的 SOCKS5 CONNECT 请求

**关键类：**
| 类 | 描述 |
|-------|-------------|
| `TunnelClient` | 管理与服务器的连接 |
| `SOCKS5Server` | 本地 SOCKS5 代理 |
| `Channel` | 一个代理连接 |

### 📚 common.py - 共享工具

**用途：** 客户端和服务器之间共享的代码。

**包含内容：**
| 组件 | 描述 |
|-----------|-------------|
| `TunnelCrypto` | 处理身份验证令牌 |
| `TrafficShaper` | 填充和时序（可选的隐蔽性） |
| `SMTPMessageGenerator` | 生成真实的邮件内容（遗留） |
| `FrameBuffer` | 从流中解析二进制帧 |
| `load_config()` | YAML 配置加载器 |
| `ServerConfig` | 服务器配置数据类 |
| `ClientConfig` | 客户端配置数据类 |

### 🔐 generate_certs.py - 证书生成器

**用途：** 为隧道创建 TLS 证书。

**生成内容：**
| 文件 | 描述 |
|------|-------------|
| `ca.key` | 证书颁发机构私钥 |
