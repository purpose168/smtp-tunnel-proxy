#!/bin/bash
#
# SMTP 隧道代理 - 更新脚本
#
# 更新服务器文件，不修改配置、证书或用户。
#
# 版本: 1.3.0

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# GitHub 原始文件 URL
GITHUB_RAW="https://raw.githubusercontent.com/purpose168/smtp-tunnel-proxy/main"

# 安装目录
INSTALL_DIR="/opt/smtp-tunnel"

# 要更新的文件（仅代码 - 不包括配置/证书/用户）
UPDATE_FILES="server.py client.py common.py generate_certs.py smtp-tunnel-adduser smtp-tunnel-deluser smtp-tunnel-listusers smtp-tunnel-update"

# 打印信息函数
print_info() {
    echo -e "${GREEN}[信息]${NC} $1"
}

# 打印警告函数
print_warn() {
    echo -e "${YELLOW}[警告]${NC} $1"
}

# 打印错误函数
print_error() {
    echo -e "${RED}[错误]${NC} $1"
}

# 检查是否为 root 用户
if [ "$EUID" -ne 0 ]; then
    print_error "请以 root 用户运行（使用 sudo）"
    exit 1
fi

# 检查安装是否存在
if [ ! -d "$INSTALL_DIR" ]; then
    print_error "SMTP 隧道未安装在 $INSTALL_DIR"
    print_error "请先运行安装程序: curl -sSL $GITHUB_RAW/install.sh | sudo bash"
    exit 1
fi

echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}  SMTP 隧道更新${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""

# 显示当前版本
if [ -f "$INSTALL_DIR/server.py" ]; then
    CURRENT_VERSION=$(grep -m1 "Version:" "$INSTALL_DIR/server.py" | sed 's/.*Version: //')
    print_info "当前版本: $CURRENT_VERSION"
fi

# 下载文件
print_info "正在下载更新..."
cd "$INSTALL_DIR"

FAILED=0
for file in $UPDATE_FILES; do
    if curl -sSL -f "$GITHUB_RAW/$file" -o "$file.new" 2>/dev/null; then
        mv "$file.new" "$file"
        echo "  已更新: $file"
    else
        print_warn "  更新失败: $file"
        rm -f "$file.new"
        FAILED=1
    fi
done

# 设置权限
chmod +x smtp-tunnel-adduser smtp-tunnel-deluser smtp-tunnel-listusers smtp-tunnel-update 2>/dev/null

# 更新符号链接
ln -sf "$INSTALL_DIR/smtp-tunnel-update" /usr/local/bin/smtp-tunnel-update 2>/dev/null

if [ $FAILED -eq 1 ]; then
    print_warn "部分文件更新失败"
fi

# 显示新版本
if [ -f "$INSTALL_DIR/server.py" ]; then
    NEW_VERSION=$(grep -m1 "Version:" "$INSTALL_DIR/server.py" | sed 's/.*Version: //')
    print_info "新版本: $NEW_VERSION"
fi

# 重启服务
print_info "正在重启服务..."
systemctl restart smtp-tunnel 2>/dev/null

if systemctl is-active --quiet smtp-tunnel; then
    print_info "服务重启成功"
else
    print_warn "服务可能未启动。请检查: systemctl status smtp-tunnel"
fi

echo ""
print_info "更新完成！"
echo ""
echo "您的配置、证书和用户未被修改。"
echo ""
