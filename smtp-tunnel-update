#!/bin/bash
#
# SMTP 隧道代理 - 更新脚本
#
# 更新服务器文件，不影响配置、证书或用户。
#
# 版本: 1.3.0

# 颜色定义
RED='\033[0;31m'      # 红色 - 错误
GREEN='\033[0;32m'    # 绿色 - 信息
YELLOW='\033[1;33m'   # 黄色 - 警告
BLUE='\033[0;34m'     # 蓝色 - 步骤
CYAN='\033[0;36m'     # 青色 - 调试
NC='\033[0m'          # 无颜色

# GitHub 原始文件 URL
GITHUB_RAW="https://raw.githubusercontent.com/purpose168/smtp-tunnel-proxy/main"

# 获取脚本所在目录
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# 安装目录（使用脚本执行时的当前路径）
INSTALL_DIR="$SCRIPT_DIR"           # 程序安装目录
CONFIG_DIR="$SCRIPT_DIR"            # 配置文件目录
VENV_DIR="$SCRIPT_DIR/venv"        # Python 虚拟环境目录
LOG_DIR="$SCRIPT_DIR/logs"           # 日志目录

# 日志文件
UPDATE_LOG="$LOG_DIR/update.log"

# 要更新的文件（仅代码 - 不包括配置/证书/用户）
# 主入口文件
MAIN_FILES="server.py client.py common.py generate_certs.py connection.py"

# 协议模块
PROTOCOL_MODULES="protocol/__init__.py protocol/core.py protocol/client.py protocol/server.py"

# 隧道模块
TUNNEL_MODULES="tunnel/__init__.py tunnel/crypto.py tunnel/base.py tunnel/client.py tunnel/session.py tunnel/server.py"

# 其他模块
OTHER_MODULES="config.py logger.py socks5_server.py"

# 管理脚本
MANAGEMENT_SCRIPTS="smtp-tunnel-adduser smtp-tunnel-deluser smtp-tunnel-listusers smtp-tunnel-update"

# 所有需要更新的文件
UPDATE_FILES="$MAIN_FILES $PROTOCOL_MODULES $TUNNEL_MODULES $OTHER_MODULES $MANAGEMENT_SCRIPTS"

# 打印函数
print_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
    log_message "INFO" "$1"
}

print_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
    log_message "WARN" "$1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
    log_message "ERROR" "$1"
}

print_step() {
    echo -e "${BLUE}[STEP]${NC} $1"
    log_message "INFO" "$1"
}

print_debug() {
    if [ "$DEBUG_MODE" = "true" ]; then
        echo -e "${CYAN}[DEBUG]${NC} $1"
    fi
    log_message "DEBUG" "$1"
}

# 日志记录函数
log_message() {
    local level=$1
    local message=$2
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    # 确保日志目录存在
    mkdir -p "$LOG_DIR" 2>/dev/null
    
    # 写入日志文件
    echo "[$timestamp] [$level] $message" >> "$UPDATE_LOG" 2>/dev/null || true
}

# 记录更新开始
log_update_start() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "" >> "$UPDATE_LOG"
    echo "========================================" >> "$UPDATE_LOG"
    echo "[$timestamp] [INFO] 开始更新程序" >> "$UPDATE_LOG"
    echo "========================================" >> "$UPDATE_LOG"
}

# 记录更新结束
log_update_end() {
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "========================================" >> "$UPDATE_LOG"
    echo "[$timestamp] [INFO] 更新程序完成" >> "$UPDATE_LOG"
    echo "========================================" >> "$UPDATE_LOG"
    echo "" >> "$UPDATE_LOG"
}

# 检查是否以 root 身份运行
check_root() {
    if [ "$EUID" -ne 0 ]; then
        print_error "请以 root 身份运行（使用 sudo）"
        log_message "ERROR" "非 root 用户尝试运行更新脚本"
        exit 1
    fi
    print_debug "Root 权限检查通过"
}

# 检查安装是否存在
check_installation() {
    if [ ! -d "$INSTALL_DIR" ]; then
        print_error "SMTP 隧道未安装在 $INSTALL_DIR"
        print_error "请先运行安装程序: curl -sSL $GITHUB_RAW/install.sh | sudo bash"
        log_message "ERROR" "安装目录不存在: $INSTALL_DIR"
        exit 1
    fi
    print_debug "安装目录检查通过: $INSTALL_DIR"
}

# 检查日志目录
check_log_directory() {
    if [ ! -d "$LOG_DIR" ]; then
        mkdir -p "$LOG_DIR"
        chmod 755 "$LOG_DIR"
        print_info "已创建日志目录: $LOG_DIR"
    fi
    print_debug "日志目录检查通过: $LOG_DIR"
}

# 获取当前版本
get_current_version() {
    if [ -f "$INSTALL_DIR/server.py" ]; then
        CURRENT_VERSION=$(grep -m1 "Version:" "$INSTALL_DIR/server.py" | sed 's/.*Version: //')
        echo "$CURRENT_VERSION"
    else
        echo "未知"
    fi
}

# 获取新版本
get_new_version() {
    if [ -f "$INSTALL_DIR/server.py" ]; then
        NEW_VERSION=$(grep -m1 "Version:" "$INSTALL_DIR/server.py" | sed 's/.*Version: //')
        echo "$NEW_VERSION"
    else
        echo "未知"
    fi
}

# 显示版本信息
show_version_info() {
    local current_ver=$(get_current_version)
    print_info "当前版本: $current_ver"
    log_message "INFO" "当前版本: $current_ver"
}

# 显示新版本信息
show_new_version_info() {
    local new_ver=$(get_new_version)
    print_info "新版本: $new_ver"
    log_message "INFO" "新版本: $new_ver"
}

# 下载并更新文件
update_files() {
    print_step "正在更新程序文件..."
    log_message "INFO" "开始下载更新文件"
    
    cd "$INSTALL_DIR"
    
    local success_count=0
    local fail_count=0
    FAILED=0
    
    for file in $UPDATE_FILES; do
        print_debug "正在下载: $file"
        
        if curl -sSL -f "$GITHUB_RAW/$file" -o "$file.new" 2>/dev/null; then
            mv "$file.new" "$file"
            echo "  已更新: $file"
            print_debug "更新成功: $file"
            log_message "INFO" "更新成功: $file"
            ((success_count++))
        else
            print_warn "  更新失败: $file"
            print_debug "更新失败: $file"
            log_message "WARN" "更新失败: $file"
            rm -f "$file.new"
            ((fail_count++))
            FAILED=1
        fi
    done
    
    print_info "更新完成: $success_count 个文件成功, $fail_count 个文件失败"
    log_message "INFO" "文件更新完成: $success_count 成功, $fail_count 失败"
}

# 设置文件权限
set_permissions() {
    print_step "正在设置文件权限..."
    print_debug "设置管理脚本执行权限"
    
    chmod +x smtp-tunnel-adduser smtp-tunnel-deluser smtp-tunnel-listusers smtp-tunnel-update 2>/dev/null
    
    print_info "文件权限已设置"
    log_message "INFO" "文件权限设置完成"
}

# 更新符号链接
update_symlinks() {
    print_step "正在更新符号链接..."
    print_debug "更新 /usr/local/bin 中的符号链接"
    
    ln -sf "$INSTALL_DIR/smtp-tunnel-update" /usr/local/bin/smtp-tunnel-update 2>/dev/null
    
    print_info "符号链接已更新"
    log_message "INFO" "符号链接更新完成"
}

# 检查虚拟环境
check_venv() {
    if [ -d "$VENV_DIR" ]; then
        print_debug "虚拟环境存在: $VENV_DIR"
        return 0
    else
        print_warn "虚拟环境不存在: $VENV_DIR"
        log_message "WARN" "虚拟环境不存在: $VENV_DIR"
        return 1
    fi
}

# 安装 Python 包
install_python_packages() {
    print_step "正在检查 Python 包更新..."
    print_debug "检查并安装 Python 依赖包"
    
    if check_venv; then
        source "$VENV_DIR/bin/activate"
        
        if pip install -r "$INSTALL_DIR/requirements.txt" 2>/dev/null; then
            print_info "Python 包已更新"
            log_message "INFO" "Python 包更新完成"
        else
            print_warn "Python 包更新失败（可能无需更新）"
            log_message "WARN" "Python 包更新失败"
        fi
        
        deactivate 2>/dev/null || true
    fi
}

# 重启服务
restart_service() {
    print_step "正在重启服务..."
    log_message "INFO" "开始重启服务"
    
    if systemctl restart smtp-tunnel 2>/dev/null; then
        sleep 2
        
        if systemctl is-active --quiet smtp-tunnel; then
            print_info "服务重启成功"
            log_message "INFO" "服务重启成功"
        else
            print_warn "服务可能未正常启动"
            log_message "WARN" "服务状态检查失败"
        fi
    else
        print_error "服务重启失败"
        log_message "ERROR" "服务重启失败"
    fi
}

# 显示更新摘要
show_summary() {
    echo ""
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}  更新完成！${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""
    echo "您的配置、证书和用户未被修改。"
    echo ""
    echo -e "${BLUE}查看日志:${NC}"
    echo "   journalctl -u smtp-tunnel -f"
    echo "   tail -f $UPDATE_LOG"
    echo ""
    echo -e "${BLUE}服务状态:${NC}"
    echo "   systemctl status smtp-tunnel"
    echo ""
}

# 主函数
main() {
    echo ""
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}  SMTP 隧道更新${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo ""
    
    check_root
    check_log_directory
    check_installation
    log_update_start
    
    show_version_info
    update_files
    set_permissions
    update_symlinks
    install_python_packages
    restart_service
    show_new_version_info
    
    if [ $FAILED -eq 1 ]; then
        print_warn "部分文件更新失败，请检查网络连接"
        log_message "WARN" "部分文件更新失败"
    fi
    
    show_summary
    log_update_end
}

# 运行主函数
main "$@"
