#!/usr/bin/env python3
"""
SMTP 隧道 - 删除用户脚本

从用户配置中移除用户。

版本: 1.3.0
"""

import argparse
import os
import sys

# 将当前目录添加到路径以便导入
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from common import load_users, save_users


def main():
    """主函数"""
    parser = argparse.ArgumentParser(
        description='从 SMTP 隧道中移除用户',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
示例:
  %(prog)s alice              # 删除用户 'alice'
  %(prog)s bob --force        # 无需确认删除
"""
    )
    parser.add_argument('username', help='要删除的用户名')
    parser.add_argument('--users-file', '-u', default='/etc/smtp-tunnel/users.yaml', help='用户文件（默认：/etc/smtp-tunnel/users.yaml）')
    parser.add_argument('--force', '-f', action='store_true', help='不要求确认')

    args = parser.parse_args()

    # 获取基础目录
    base_dir = os.path.dirname(os.path.abspath(__file__))

    # 加载现有用户
    users_file = args.users_file
    if not os.path.isabs(users_file):
        users_file = os.path.join(base_dir, users_file)

    users = load_users(users_file)

    # 检查用户是否存在
    if args.username not in users:
        print(f"错误: 未找到用户 '{args.username}'")
        return 1

    # 确认删除
    if not args.force:
        response = input(f"删除用户 '{args.username}'? [y/N]: ").strip().lower()
        if response != 'y':
            print("已取消")
            return 0

    # 移除用户
    del users[args.username]

    # 保存用户文件
    save_users(users_file, users)
    print(f"用户 '{args.username}' 已移除")

    # 提醒 ZIP 文件
    zip_file = f"{args.username}.zip"
    if os.path.exists(zip_file):
        print(f"注意: 客户端包 '{zip_file}' 仍然存在 - 如需要请手动删除")

    return 0


if __name__ == '__main__':
    sys.exit(main())
